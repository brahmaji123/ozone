- name: Create normalized service mapping (fixed version)
  set_fact:
    normalized_services: >-
      {%
        set ns = namespace(result={})
      %}{%
        for item in cluster_services.json.get('items', [])
      %}{%
        set base_name = (item.name | default('')) | regex_replace('[-_]\\d+$', '') | lower
      %}{%
        if item.name is defined and ns.result.update({base_name: ns.result.get(base_name, []) + [item.name]})
      %}{% endif %}{%
        endfor
      %}{{
        ns.result
      }}
  no_log: true
