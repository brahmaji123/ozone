- name: Create normalized service mapping
  set_fact:
    normalized_services: >-
      {%
        set services_list = cluster_services.json.items
      %}{%
        set ns = namespace(result={})
      %}{%
        for service in services_list
      %}{%
        set base_name = service.name | regex_replace('[-_]\\d+$', '') | lower
      %}{%
        if ns.result.update({base_name: ns.result.get(base_name, []) + [service.name]})
      %}{% endif %}{%
        endfor
      %}{{
        ns.result
      }}
  no_log: true
